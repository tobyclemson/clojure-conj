<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 3.0.2 (195746)"/><meta name="keywords" content="clojure, conference, day1"/><meta name="created" content="2011-11-10 10:37:37 -0500"/><meta name="updated" content="2011-11-11 15:16:15 -0500"/><title>"Clojail", Anthony Grimes</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
<div><a href="%22Clojail%22,%20Anthony%20Grimes.resources/anthony-grimes-clojail.pdf">anthony-grimes-clojail.pdf</a><b><br/></b></div>
<div><b><br/></b></div>
<div><b>Background</b><br/></div>
<ul>
<li>Code is dangerous!
<ul>
<li>read and write to file system etc.</li>
</ul>
</li>
<li>We need it to be, couldn't do stuff otherwise</li>
<li>Don't normally care about sandboxing
<ul>
<li>we are our own sandbox</li>
<li>don't let anyone else execute code on your system</li>
</ul>
</li>
<li>Clojure allows code to be eval'ed from wherever you want</li>
</ul>
<b>The JVM Sandbox</b>
<ul>
<li>Thorough</li>
<li>Prevents I/O</li>
<li>Denies access to certain methods and classes</li>
<li>Not enough for every single use case</li>
</ul>
<b>Sandboxing Clojure</b>
<ul>
<li>Sandboxing state of Clojure is the hard part</li>
<li>Redeffing, infinite looping etc.</li>
<li>TryClojure, 4Clojure, LazyBot - allow user entered clojure</li>
</ul>
<div><b>How?</b></div>
<ul>
<li>Look at namespaces symbols, classes vars etc.</li>
<li>Def - can abuse memory</li>
<li>Loops - timeouts!</li>
<li>Threads - can be used to avoid timeouts, must die</li>
<li>The dot (.) special form
<ul>
<li>Can abuse Clojure's Java</li>
<li>Cannot be got rid of</li>
<li>Cannot be rebound as it is a special form</li>
<li>Must be replaced entirely</li>
</ul>
</li>
</ul>
<b>Why stop there?</b>
<ul>
<li>Extensibility
<ul>
<li>Safety not the only concern</li>
<li>Customised evaluation contexts
<ul>
<li>Allow users to block whatever they want</li>
</ul>
</li>
</ul>
</li>
</ul>
<b>Clojail</b>
<ul>
<li>Takes advantage of JVM sandbox</li>
<li>Sandboxes the Clojure side of things</li>
<li>Does very selective blacklisting</li>
<li>...</li>
<li>Provides configurable sandboxes
<ul>
<li>Anything evaluated in the sandbox is subject to the sandboxing rules</li>
</ul>
</li>
<li>(sandbox ...)
<ul>
<li>takes a set of things like Java classes, packages, symbols, sets, namespaces -> testers</li>
</ul>
</li>
<li>clojail.testers
<ul>
<li>a selection of testers e.g., secure-tester</li>
</ul>
</li>
<li>(sandbox*) - dynamic sandboxes, choose the testers on each evaluation</li>
<li>Sandbox automatically destroys long running executions
<ul>
<li>timeout can be specified</li>
</ul>
</li>
<li>Defs
<ul>
<li>max-defs determines how many things can be deffed</li>
<li>anything over max-defs is undefined</li>
</ul>
</li>
<li>Each sandbox is its own namespace
<ul>
<li>namespace can be set when sandboxes are created</li>
</ul>
</li>
<li>Secure dispensations
<ul>
<li>clojail.jvm</li>
<li>can define a security context and associate it with a particular namespace</li>
<li>can independently sandbox the jvm using (jvm-sandbox ...)</li>
</ul>
</li>
<li>Can evaluate things in the sandbox at creation time - available thereafter on the sandbox</li>
<li>Can bind to anything in the sandbox from outside thus hooking in to activity in the sandbox</li>
</ul>
<b>Implementation</b>
<ul>
<li>Steps:
<ul>
<li>1. Separate and Check<br/>
<ul>
<li>macroexpand most things</li>
<li>convert resulting structure to a collection</li>
<li>flatten the collection</li>
<li>process each element and check against testers...?</li>
</ul>
</li>
<li>2. Modify to sandbox anything missed before evaluation
<ul>
<li>e.g., replace '.' special form</li>
<li>use tester, check against object, fail if tester not satisfied</li>
</ul>
</li>
</ul>
</li>
<li>Timeouts:
<ul>
<li>execute inside a future with a timeout</li>
<li>stop thread group if timeout exceeded</li>
</ul>
</li>
<li>Threads:
<ul>
<li>timeout handles basic threads (Thread. ...)</li>
<li>doesn't solve the threadpool problem...secure tester tries to</li>
</ul>
</li>
<li>Evaluator:
<ul>
<li>in the context of the sandbox namespace</li>
<li>evaluate the code</li>
<li>use context of bindings</li>
<li>use jvm sandbox rules as well.</li>
</ul>
</li>
<li>(sandbox* ...) ties it all together
<ul>
<li>rebind *ns* to the sandbox namespace</li>
<li>refer clojure (if true) inside the namespace</li>
<li>evaluate an init function which sets up the namespace however you want</li>
<li>store init-defs and custom dot macro</li>
<li>return function wrapping code, tester and bindings
<ul>
<li>initialise with jvm tester and clojure tester</li>
<li>execute above steps over code being added to the sandbox</li>
<li>wipe the namespace of any defs that shouldn't be there</li>
</ul>
</li>
</ul>
</li>
</ul>
<b>Summary</b>
<ul>
<li>Not always enough</li>
<li>Take every precaution available</li>
<li>JVM sandbox is good but not infallible</li>
<li>Run code in its own user account</li>
<li>Goal is to safely evaluate code in the <b>same</b> namespace</li>
</ul>
<b>Usage Guidelines</b>
<ul>
<li>Always use JVM sandbox</li>
<li>Update clojail regularly</li>
<li>Always report any issues</li>
<li>Avoid sharing the same namespace with everybody</li>
<li>...</li>
</ul>
</body></html>